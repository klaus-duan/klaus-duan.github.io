---
layout:     post
title:      åˆ©ç”¨å…è´¹å¹³å°åŠ è½½chatglm
subtitle:   é£æ¡¨AI studioç®€ä»‹ä»¥åŠchatglmçš„æœ¬åœ°éƒ¨ç½²
date:       2024-05-28
author:     Klaus
header-img: img/post-bg-cook.jpg
catalog: true
tags:
    - chatglm
    - å¤§æ¨¡å‹
    - ç™¾åº¦é£æ¡¨
---

# å‰è¨€

chatglmçš„githubé¡¹ç›®ä»‹ç»ä¸­ï¼Œä½œè€…å»ºè®®ç”¨16Gå†…å­˜ä»¥ä¸Šçš„æ˜¾å¡æ¥è¿è¡Œè¿™ä¸ªé¡¹ç›®ã€‚ç”±äºæ€•æˆ‘çš„å°ç”µè„‘è·‘æŠ¥åºŸä»¥åŠå­¦é™¢çš„ç¡¬ç›˜å·²ç»è¢«æŒ¤çˆ†äº†ã€‚æœ€ç»ˆæ‰¾åˆ°äº†å…è´¹çš„å¹³å°æ¥åŠ è½½chatglmæ¨¡å‹ã€‚

é£æ¡¨AI studioè‡ªå¸¦ä¸¤ä¸ªæ–‡ä»¶å¤¹(`work`å’Œ`data`)ï¼Œå­˜æ”¾åœ¨`work`ä¸­çš„æ–‡ä»¶ä¸ä¼šè¢«è‡ªåŠ¨æ¸…ç†ï¼ˆæ”¾åœ¨å¤–é¢çš„æ–‡ä»¶æ¯æ¬¡é‡å¯åä¼šæ¶ˆå¤±ï¼‰ï¼Œæ‰€ä»¥é‡è¦æ–‡ä»¶åŠ¡å¿…å­˜æ”¾åœ¨`work`æ–‡ä»¶å¤¹ä¸­ã€‚

# å…³äºAI studioçš„conda

åœ¨AI studioæ–°å»ºé¡¹ç›®çš„Jupyter notebookä¸­ï¼Œè‡ªå¸¦ä¸€ä¸ªcondaï¼Œä½†æ˜¯è¿™ä¸ªcondaä½¿ç”¨æ¯”è¾ƒéº»çƒ¦ï¼ˆæ¯”å¦‚æ— æ³•åƒå¹³å¸¸é‚£æ ·å»ºç«‹ç¯å¢ƒï¼‰ã€‚

æ‰€ä»¥è¦å®‰è£…ä¸€ä¸ªæ–°çš„condaã€‚è¿™ç¯‡æ–‡ç« ä¸­å®‰è£…çš„æ˜¯`Miniconda3-latest-Linux-x86_64.sh`ã€‚

## åœ¨é¡¹ç›®jupyter notebookä¸­å®‰è£…æ–°çš„conda

### ç™»é™†ç™¾åº¦ AI Studio å¹¶æŒ‰ç…§æ•™ç¨‹åˆ›å»ºæ–°é¡¹ç›®

ç™»é™†ä¹‹åå¯ä»¥æ ¹æ®ä¸ªäººå–œå¥½é€‰æ‹©æ§åˆ¶ç•Œé¢çš„å½¢å¼ï¼Œæœ‰vscodeå½¢å¼å’Œjupyterlabå½¢å¼å¯é€‰ã€‚

### ä¸Šä¼ minicondaå®‰è£…åŒ…

æˆ‘è¯•äº†å‡ æ¬¡é€šè¿‡AI studioçš„terminalçš„æŒ‡ä»¤ä¸‹è½½å®‰è£…åŒ…ï¼Œä½†æ˜¯éƒ½å¤±è´¥äº†ã€‚æœ€ç»ˆæ˜¯å°†å®‰è£…åŒ…ä¸‹è½½åˆ°æœ¬åœ°ç„¶åä¸Šä¼ åˆ°é£æ¡¨çš„AI studioé‡Œã€‚æˆ‘å®‰è£…çš„æ˜¯`Miniconda3-latest-Linux-x86_64.sh`ç‰ˆæœ¬ã€‚

### æ‰§è¡Œå®‰è£…åŒ…

æ‰“å¼€AI studioçš„terminalï¼Œè¾“å…¥æŒ‡ä»¤`bash Miniconda3-latest-Linux-x86_64.sh`ã€‚åœ¨ä¸€è·¯yeså’Œyæ‰§è¡Œåï¼Œæ³¨æ„å®‰è£…condaçš„ä½ç½®è®¾ç½®æˆ`~/work/*conda3`ï¼Œå³ï¼š

	[/home/aistudio/miniconda3] >>> ~/work/*conda3
	
ä¸€ç›´yes/yä¹‹åï¼Œå®‰è£…å®Œæˆã€‚

## ä½¿ç”¨æ–°å®‰è£…çš„conda

æ¿€æ´»æ–°å®‰è£…çš„condaç¯å¢ƒä¸èƒ½é€šè¿‡å¹³æ—¶çš„`conda activate`æŒ‡ä»¤ã€‚è€Œæ˜¯è¦åœ¨terminalè¾“å…¥`source work/*conda3/bin/activate`ï¼Œæ­¤æ—¶å°±æ¿€æ´»äº†baseç¯å¢ƒã€‚

> `(base)` aistudio@jupyter:~$ 

ç°åœ¨å°±å¯ä»¥åƒå¹³æ—¶ä½¿ç”¨condaä¸€æ ·æ‰§è¡ŒæŒ‡ä»¤

å¦‚`conda env list`ï¼šå¯ä»¥å‘ç°æœ‰ä¸¤ä¸ªcondaï¼ˆ`conda`å’Œ`*conda`)

	(base) aistudio@:~$ conda env list
	# conda environments:
	#
	base                  *  /home/aistudio/work/*conda3
	glm                      /home/aistudio/work/*conda3/envs/glm
	                         /opt/conda/envs/python35-paddle120-env
	                         
ä¹‹åæ¯æ¬¡ä½¿ç”¨æ–°å®‰è£…çš„condaæ—¶ï¼Œéƒ½è¦æ‰§è¡Œ`source work/*conda3/bin/activate`ï¼Œä¹‹åå†åƒå¹³æ—¶é‚£æ ·ä½¿ç”¨condaæŒ‡ä»¤ã€‚

## åˆ›å»ºcondaç¯å¢ƒ

åœ¨å®‰è£…åº“ä¹‹å‰å¯ä»¥å°è¯•è®¾ç½®æˆå›½å†…çš„é•œåƒï¼Œé€Ÿåº¦ä¼šå¿«å¾ˆå¤šã€‚

å‚è€ƒ [jupyter notebookä¸­çš„ç¯å¢ƒè®¾ç½®](https://klaus-duan.github.io/2023/09/16/jupyterhubä¸­çš„ç¯å¢ƒè®¾ç½®/)ã€‚è¿™ä¸€æ­¥è¦åˆ›å»ºç¯å¢ƒå¹¶å®‰è£…ä¾èµ–`pip install -r requirements.txt`

# chatglmæ–‡ä»¶å‡†å¤‡å’Œè¿è¡Œ

ç”±äºAI studioä¸å¯ä»¥æŒ‚ğŸªœï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©çš„æ˜¯æœ¬åœ°éƒ¨ç½²ã€‚

## github clone chatglmçš„é¡¹ç›®

æ‰“å¼€terminalï¼Œåˆ‡æ¢æ–‡ä»¶å¤¹

> cd ~/work   		
> 
>  # å­˜æ”¾åœ¨workä¸­çš„æ–‡ä»¶ä¸ä¼šè¢«ç³»ç»Ÿæ¸…é™¤

è¾“å…¥`git clone`ï¼Œå°†chatglmçš„é¡¹ç›®cloneåˆ°workæ–‡ä»¶å¤¹

> aistudio@jupyter:~/work$ `git clone https://github.com/THUDM/ChatGLM-6B.git`

å¦‚æœä½ çš„æœåŠ¡å™¨å¯ä»¥æŒ‚ğŸªœçš„è¯ï¼Œå…¶å®æ‰¾åˆ°é¡¹ç›®ä¸­çš„æ–‡ä»¶ç›´æ¥æ‰§è¡Œå°±å¯ä»¥äº†ã€‚ä½†æ˜¯ç”±äºAI studioä¸èƒ½è¿æ¥åˆ°huggingfaceï¼Œæ‰€ä»¥éœ€è¦å°†huggingfaceä¸Š(æˆ–é€šè¿‡å›½å†…çš„huggingfaceé•œåƒ)[`THUDM/chatglm-6b`](https://huggingface.co/THUDM/chatglm-6b/tree/main)çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¸‹è½½ä¸‹æ¥ï¼Œç„¶åä¸Šä¼ åˆ°AI studioçš„é¡¹ç›®ä¸­ï¼Œå…·ä½“è§ä¸‹ã€‚

æ­¤å¤–ï¼Œç”±äºAI studioçš„é¡¹ç›®ä¸Šä¼ æœ€å¤§æ–‡ä»¶å¤§å°ä¸º500Mï¼Œæ‰€ä»¥`THUDM/chatglm-6b`ä¸­çš„8ä¸ª`bin`æ–‡ä»¶ä¸å¯ä»¥ç›´æ¥ä¸Šä¼ ï¼Œæˆ‘çš„æ–¹æ³•æ˜¯é€šè¿‡å°†è¿™8ä¸ªbinæ–‡ä»¶ä¸Šä¼ åˆ°é¡¹ç›®çš„æ•°æ®é›†ã€‚å‚è€ƒ[3. æŒ‚è½½æ•°æ®é›†(å®˜æ–¹æŒ‡å®šæœ€ä½³æ–¹æ¡ˆ)](https://blog.csdn.net/m0_56830873/article/details/129351169)ï¼Œ_ä¸Šä¼ è¿‡ç¨‹å¯èƒ½ä¼šæ¯”è¾ƒæ…¢è€Œä¸”ç»å¸¸æ–­æ‰_ã€‚é…ç½®æ•°æ®é›†å®Œæˆåï¼Œé¡¹ç›®ä¸­çš„`data`æ–‡ä»¶å¤¹è‡ªåŠ¨ç”Ÿæˆäº†ä¸€ä¸ªæ–°æ–‡ä»¶å¤¹ï¼ˆæ¯”å¦‚æˆ‘çš„å«`data275156`ï¼‰ã€‚ä¹‹åå°†`THUDM/chatglm-6b`å…¶ä»–æ–‡ä»¶ä¸€ä¸ªä¸å·®ä¸Šä¼ åˆ°`data275156`ä¸­ã€‚

**æ³¨ï¼š**`data275156`ä¸­çš„8ä¸ª`bin`æ–‡ä»¶åœ¨é‡å¯ä¹‹åè¿˜æ˜¯ä¾ç„¶å­˜åœ¨çš„ï¼Œä½†æ˜¯å…¶ä»–æ–‡ä»¶ä¼šæ¶ˆå¤±ï¼Œè¦é‡æ–°ä¸Šä¼ ï¼Œå¯èƒ½æ˜¯å› ä¸ºé‚£8ä¸ª`bin`æ–‡ä»¶è¢«é…ç½®åˆ°äº†æ•°æ®é›†é‡Œï¼Œæ‰€ä»¥`data275156`ä»¥åŠ8ä¸ª`bin`æ–‡ä»¶ä¸ä¼šæ¶ˆå¤±ã€‚

**5/31æ›´æ–°ï¼š**å…¶å®å¯ä»¥å°†`data275156`è½¬ç§»åˆ°`work`æ–‡ä»¶ä¸­ï¼Œè¿™æ ·æ¯æ¬¡é‡å¯æ—¶å°±ä¸ç”¨å†ä¸Šä¼ æ–‡ä»¶ã€‚åªæ˜¯é¡¹ç›®ä½“ç§¯ä¼šå¢åŠ å¾ˆå¤šï¼Œç”±æœ€åˆçš„å°†è¿‘7Gæ¶¨åˆ°å°†è¿‘20Gï¼Œåœ¨æ¯æ¬¡é€€å‡ºæ—¶é¡¹ç›®ä¿å­˜æ—¶é—´ä¼šå˜é•¿ã€‚

> mv data/data275156 ~/work

## é¡¹ç›®ä»£ç ä¿®æ”¹

æˆ‘ä»¬ä¸»è¦ä»‹ç»`work/ChatGLM-6B`ä¸­`cli_demo.py`çš„ä½¿ç”¨ã€‚

`cli_demo.py`ä»£ç ä¿®æ”¹ï¼šï¼ˆä¸»è¦æ˜¯è·¯å¾„è®¾ç½®æˆæˆ‘ä»¬è‡ªå·±çš„`model_path`ï¼Œæ³¨æ„è¦ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰

	import os
	import platform
	import signal
	from transformers import AutoTokenizer, AutoModel
	import readline
	
	model_path = '/home/aistudio/data/data275156'
	tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=True)
	model = AutoModel.from_pretrained(model_path, trust_remote_code=True).half().cuda()
	model = model.eval()

terminalä¸­åˆ‡æ¢æ–‡ä»¶å¤¹ï¼š

> cd work/ChatGLM-6B

æ¿€æ´»ç›¸åº”çš„ç¯å¢ƒï¼š

> conda activate glm

æ‰§è¡Œ`cli_demo.py`æ–‡ä»¶

> python cli_demo.py

åŠ è½½å®Œ8ä¸ª`bin`æ–‡ä»¶åï¼Œåœ¨terminalä¼šå‡ºç°é—®è¯æ¡†ï¼š

![](https://raw.githubusercontent.com/klaus-duan/klaus-duan.github.io/master/img/post-bg-chatglm1.jpeg)

å› ä¸ºæ˜¯æ²¡æœ‰è°ƒæ•´è¿‡çš„æ¨¡å‹ï¼Œæ‰€ä»¥éš¾å…ä¼šèƒ¡è¯´å…«é“ï¼š

![](https://raw.githubusercontent.com/klaus-duan/klaus-duan.github.io/master/img/post-bg-chatglm2.jpeg)

--

# **è¿è¡Œæ—¶é‡åˆ°çš„é”™è¯¯**

æœ€å¼€å§‹å°è¯•è¿è¡Œè¿‡ `web_demo.py` ä»¥åŠ `web_demo2.py`ï¼Œä½†æ˜¯å®ƒæœ€åä¼šè¾“å‡ºä¸€ä¸ª`http:`çš„ç½‘å€ï¼Œè¾“å‡ºä¹‹å`http:`å°±è‡ªåŠ¨å˜æˆäº†`www.`ï¼Œä¸€ç›´æ²¡æœ‰æ”¹å¥½ï¼Œä¸çŸ¥é“æ˜¯ç½‘ç»œè¿˜æ˜¯ä»£ç çš„é—®é¢˜
